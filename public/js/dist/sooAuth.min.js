jQuery(function($){"use strict";window.sooAuth={init:function(){if(!(typeof sooAuthOptions!=="undefined"&&typeof sooAuthOptions!=="undefined")){console.log("Checkout Option not loaded correctly, the store is closed or there is an error");this.hideLoadingLayer();return}if(this.isCustomerLoggedIn()){this.getCustomerProfile().then(response=>{if(!response.ok){throw new Error("Cannot get the customer profile")}return response.json()}).then(data=>{localStorage.setItem("loggedInCustomer",JSON.stringify(data));this.hideLoadingLayer();if(sooAuth.getSourcePage()==="checkout"){sooAuth.goToCheckoutPage(data)}if(sooAuth.getSourcePage()==="myOrders"){sooAuth.goToMyOrdersPage(data)}}).catch(error=>{localStorage.removeItem("customerJwtToken");localStorage.removeItem("loggedInCustomer");localStorage.removeItem("sooPointsHistory");this.hideLoadingLayer();this.showOrHideASection("login-section",true)})}else{this.hideLoadingLayer();this.showOrHideASection("login-section",true);this.isFacebookLoginFeatureEnabled()}if($("form#moo-login-form").length){sooAuth.loginForm=$("form#moo-login-form");sooAuth.loginForm.on("submit",this.login)}if($("form#moo-signup-form").length){sooAuth.signUpForm=$("form#moo-signup-form");sooAuth.signUpForm.on("submit",this.signup)}if($("form#moo-resetPassword-form").length){sooAuth.resetPasswordForm=$("form#moo-resetPassword-form");sooAuth.resetPasswordForm.on("submit",this.resetPassword)}},startSubmitingAform:function(form){form.data("submitted",true);form.find("button[type=submit]").html('<div class="dot-flashing"></div>');setTimeout(()=>{this.finishSubmitingAform(form)},3e4)},finishSubmitingAform:function(form){form.data("submitted",false);var button=form.find("button[type=submit]");button.html(button.attr("aria-label"))},onInputChange:function(elem){if(elem.value){$(elem).removeClass("moo-has-error");$(elem).parent().removeClass("moo-has-error");$(elem).next().hide()}},loginViaFacebook:function(){const btn=$("#moo-login-section .login-social-section > div > div:nth-child(1) > button");const btnTxt=btn.html();btn.html('<div class="dot-flashing"></div>');if(this.isFacebookLoginFeatureEnabled()){FB.login(function(response){if(response.status==="connected"){if(response.authResponse){fetch(sooAuthOptions.restApiUrl+"moo-clover/v2/customers/fb-login",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify({userToken:response.authResponse.accessToken,userId:response.authResponse.userID})}).then(res=>{if(!res.ok){throw new Error(mooObjectL10n.anErrorOccurred)}return res.json()}).then(data=>{btn.html(btnTxt);if(!data.customer||!data.access_token){sooAuth.showErrorAlert(mooObjectL10n.anErrorOccurred,"")}else{localStorage.setItem("customerJwtToken",data.access_token);localStorage.setItem("loggedInCustomer",JSON.stringify(data.customer));if(sooAuth.getSourcePage()==="checkout"){sooAuth.goToCheckoutPage(data.customer)}if(sooAuth.getSourcePage()==="myOrders"){sooAuth.goToMyOrdersPage(data.customer)}}}).catch(err=>{btn.html(btnTxt);sooAuth.showErrorAlert(mooObjectL10n.error,err.message)})}else{btn.html(btnTxt);sooAuth.showErrorAlert(mooObjectL10n.error,mooObjectL10n.anErrorOccurred)}}else{btn.html(btnTxt);sooAuth.showErrorAlert(mooObjectL10n.error,mooObjectL10n.anErrorOccurred)}},{scope:"public_profile,email"})}else{btn.html(btnTxt);this.showErrorAlert(mooObjectL10n.error,mooObjectL10n.anErrorOccurred)}},login:function(e){e.preventDefault();if(sooAuth.loginForm.data("submitted")===true){return false}else{sooAuth.startSubmitingAform(sooAuth.loginForm)}const emailInput=sooAuth.loginForm.find("#sooInputEmail");const passwordInput=sooAuth.loginForm.find("#sooInputPassword");if(!emailInput.val()){emailInput.parent().addClass("moo-has-error");emailInput.next().show();emailInput.focus();sooAuth.finishSubmitingAform(sooAuth.loginForm);return}if(!passwordInput.val()){passwordInput.parent().addClass("moo-has-error");passwordInput.next().show();passwordInput.focus();sooAuth.finishSubmitingAform(sooAuth.loginForm);return}sooAuth.loginCustomer(emailInput.val().trim(),passwordInput.val())},signup:function(e){e.preventDefault();if(sooAuth.signUpForm.data("submitted")===true){return false}else{sooAuth.startSubmitingAform(sooAuth.signUpForm)}const regex_email=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;const formElements={firstNameInput:sooAuth.signUpForm.find("#sooSignupInputFirstName"),lastNameInput:sooAuth.signUpForm.find("#sooSignupInputLastName"),emailInput:sooAuth.signUpForm.find("#sooSignupInputEmail"),phoneInput:sooAuth.signUpForm.find("#sooSignupInputPhone"),passwordInput:sooAuth.signUpForm.find("#sooSignupInputPassword"),confirmPasswordInput:sooAuth.signUpForm.find("#sooSignupInputConfirmPassword")};for(const el in formElements){if(!formElements[el].val()){formElements[el].parent().addClass("moo-has-error");formElements[el].next().show();formElements[el].focus();sooAuth.finishSubmitingAform(sooAuth.signUpForm);return}}if(!regex_email.test(formElements.emailInput.val())){formElements.emailInput.parent().addClass("moo-has-error");formElements.emailInput.next().show();formElements.emailInput.focus();sooAuth.finishSubmitingAform(sooAuth.signUpForm);return}if(formElements.passwordInput.val().length<6){sooAuth.showErrorAlert("The password must be at least 6 characters.","");formElements.passwordInput.parent().addClass("moo-has-error");formElements.passwordInput.next().show();formElements.passwordInput.focus();sooAuth.finishSubmitingAform(sooAuth.signUpForm);return}if(formElements.passwordInput.val()!==formElements.confirmPasswordInput.val()){sooAuth.showErrorAlert("The passwords didn't match","");formElements.confirmPasswordInput.parent().addClass("moo-has-error");formElements.confirmPasswordInput.next().show();formElements.confirmPasswordInput.focus();sooAuth.finishSubmitingAform(sooAuth.signUpForm);return}$.ajax({type:"POST",cache:false,url:sooAuthOptions.restApiUrl+"moo-clover/v2/customers/signup",contentType:"application/json; charset=UTF-8",data:JSON.stringify({first_name:formElements.firstNameInput.val().trim(),last_name:formElements.lastNameInput.val().trim(),phone:formElements.phoneInput.val().trim(),email:formElements.emailInput.val().trim(),password:formElements.passwordInput.val(),password_confirmation:formElements.confirmPasswordInput.val()})}).done(function(data){if(!data.customer||!data.access_token){sooAuth.showErrorAlert(mooObjectL10n.anErrorOccurred,"")}else{localStorage.setItem("customerJwtToken",data.access_token);localStorage.setItem("loggedInCustomer",JSON.stringify(data.customer));sooAuth.finishSubmitingAform(sooAuth.signUpForm);if(sooAuth.getSourcePage()==="checkout"){sooAuth.goToCheckoutPage(data.customer)}if(sooAuth.getSourcePage()==="myOrders"){sooAuth.goToMyOrdersPage(data.customer)}}}).fail(function(data){sooAuth.finishSubmitingAform(sooAuth.signUpForm);let errorMsg="";if(data.responseJSON&&data.responseJSON.message){errorMsg=data.responseJSON.message}else{errorMsg=mooObjectL10n.useForgetPassword}sooAuth.showErrorAlert(errorMsg,"")});return false},resetPassword:function(e){e.preventDefault();const btn=$("#moo-resetPassword-form .sooCheckoutPrimaryButtonInput");const btnTxt=btn.html();if(sooAuth.resetPasswordForm.data("submitted")===true){return false}else{sooAuth.startSubmitingAform(sooAuth.resetPasswordForm)}const regex_email=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;const formElements={emailInput:sooAuth.resetPasswordForm.find("#sooInputEmail4Reset")};for(const el in formElements){if(!formElements[el].val()){formElements[el].parent().addClass("moo-has-error");formElements[el].next().show();formElements[el].focus();sooAuth.finishSubmitingAform(sooAuth.resetPasswordForm);return}}if(!regex_email.test(formElements.emailInput.val())){formElements.emailInput.parent().addClass("moo-has-error");formElements.emailInput.next().show();formElements.emailInput.focus();sooAuth.finishSubmitingAform(sooAuth.resetPasswordForm);return}btn.html('<div class="dot-flashing"></div>');$.ajax({type:"POST",cache:false,url:sooAuthOptions.restApiUrl+"moo-clover/v2/customers/reset-password",contentType:"application/json; charset=UTF-8",data:JSON.stringify({email:formElements.emailInput.val().trim()})}).done(function(data){btn.html(btnTxt);sooAuth.finishSubmitingAform(sooAuth.resetPasswordForm);if(data.message){sooAuth.showResetPasswordForm(formElements.emailInput.val().trim(),data.message)}else{let msg="Please use a valid email";if(data.error){msg=data.error}msg="E-mail not found. Try again or create a new account";sooAuth.showErrorAlert("An error has occurred",msg)}}).fail(function(data){btn.html(btnTxt);sooAuth.finishSubmitingAform(sooAuth.resetPasswordForm);let errorMsg="";if(data.responseJSON&&data.responseJSON.message){errorMsg=data.responseJSON.message}else{errorMsg=mooObjectL10n.useForgetPassword}sooAuth.showErrorAlert(errorMsg,"")})},cancelResetPassword:function(e){e.preventDefault();sooAuth.showOrHideASection("login-section",true)},showResetPasswordForm:function(email,title){Swal.fire({text:title,input:"text",inputValue:"",inputPlaceholder:"Enter your verification code",showCancelButton:true,cancelButtonText:mooObjectL10n.close,confirmButtonText:"Check",showLoaderOnConfirm:true,allowOutsideClick:false,inputValidator:value=>{if(value.length!==8){return"Error: OTP code not valid"}},preConfirm:code=>{return fetch(sooAuthOptions.restApiUrl+"moo-clover/v2/customers/check-otp",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify({email:email,code:code})}).then(response=>{if(!response.ok){throw new Error("OTP code not valid")}return response.json()}).then(data=>{if(data.message&&data.message!=="This Otp code is valid"){throw new Error("OTP code not valid")}data.code=code;return data}).catch(error=>{Swal.showValidationMessage(error)})}}).then(function(data){if(data.value&&data.value.code){sooAuth.showNewPasswordForm(email,data.value.code)}},function(data){if(data.dismiss==="cancel"){Swal.close()}})},showNewPasswordForm:function(email,code){let newPass;Swal.fire({title:"Please choose a new password",input:"password",inputValue:"",showCancelButton:true,cancelButtonText:mooObjectL10n.close,confirmButtonText:"Save",showLoaderOnConfirm:true,allowOutsideClick:false,inputValidator:value=>{if(value.length<8){return"Error: The password must be at least 8 characters"}},preConfirm:newPassword=>{newPass=newPassword;return fetch(sooAuthOptions.restApiUrl+"moo-clover/v2/customers/new-password",{method:"POST",mode:"cors",cache:"no-cache",credentials:"same-origin",headers:{"Content-Type":"application/json"},redirect:"follow",referrerPolicy:"no-referrer",body:JSON.stringify({email:email,code:code,password:newPassword,password_confirmation:newPassword})}).then(response=>{if(!response.ok){throw new Error("An error has occurred, please try again")}return response.json()}).catch(error=>{Swal.showValidationMessage(error)})}}).then(function(data){if(data.value&&data.value.message){Swal.fire(data.value.message);if(data.value.message==="Password has been successfully changed"){sooAuth.loginCustomer(email,newPass)}}},function(data){if(data.dismiss==="cancel"){Swal.close()}})},hideLoadingLayer(){$("#moo-login-section > div.sooOverlayLoader").hide()},showOrHideASection(section,show){$("div.moo-section").hide();const elem=$("#moo-"+section);if(show){elem.show()}else{elem.hide()}},isCustomerLoggedIn(){return localStorage.getItem("customerJwtToken")!==null},getLoggedInCustomer(){if(localStorage.getItem("loggedInCustomer")){return JSON.parse(localStorage.getItem("loggedInCustomer"))}return null},getSourcePage(){const dataInfo=$("#sooAuthSection").data("sooAuthPage");if(dataInfo){return dataInfo}else{if($("#moo_CheckoutContainer").length){return"checkout"}if($("#sooMyOrdersContainer").length){return"myOrders"}}return null},getCustomerProfile(){let token=localStorage.getItem("customerJwtToken");return fetch(sooAuthOptions.restApiUrl+"moo-clover/v2/customers/me",{method:"GET",mode:"cors",cache:"no-cache",headers:{"Content-Type":"application/json",Authorization:"Bearer "+token},redirect:"follow",referrerPolicy:"no-referrer"})},isMobile:function(){if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)){return true}return false},isFacebookLoginFeatureEnabled:function(){if(sooAuthOptions.fbAppId){if(sooAuthOptions.fbAppId!==""){this.initFacebookSdk();return true}}return false},initFacebookSdk:function(){window.fbAsyncInit=function(){FB.init({appId:sooAuthOptions.fbAppId,xfbml:true,cookie:true,version:"v2.8"});FB.AppEvents.logPageView()};(function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(d.getElementById(id)){return}js=d.createElement(s);js.id=id;js.src="//connect.facebook.net/en_US/sdk.js";fjs.parentNode.insertBefore(js,fjs)})(document,"script","facebook-jssdk")},changeElemVisibility:function(selector,showOrHide){if(showOrHide==="show"){$(selector).show()}if(showOrHide==="hide"){$(selector).hide()}},showErrorAlert:function(title,message,focusOnElem=null){if(focusOnElem){Swal.fire({title:title,text:message,icon:"error"}).then(function(){setTimeout(function(){$(focusOnElem).focus()},500)})}else{Swal.fire({title:title,text:message,icon:"error"})}},showSuccessAlert:function(title,message,focusOnElem=null){if(focusOnElem){Swal.fire(title,message,"success").then(function(){setTimeout(function(){$(focusOnElem).focus()},500)})}else{Swal.fire(title,message,"success")}},isTrue:function(param){return param===true||param===1||param==="1"||param==="true"},loginCustomer:function(email,password){$.ajax({type:"POST",cache:false,url:sooAuthOptions.restApiUrl+"moo-clover/v2/customers/login",contentType:"application/json; charset=UTF-8",data:JSON.stringify({email:email,password:password})}).done(function(data){sooAuth.finishSubmitingAform(sooAuth.loginForm);if(!data.customer||!data.access_token){sooAuth.showErrorAlert(mooObjectL10n.anErrorOccurred,"")}else{history.pushState({},"Checkout");localStorage.setItem("customerJwtToken",data.access_token);localStorage.setItem("loggedInCustomer",JSON.stringify(data.customer));if(sooAuth.loginForm.find("#sooInputPassword")){sooAuth.loginForm.find("#sooInputPassword").val("")}if(sooAuth.getSourcePage()==="checkout"){sooAuth.goToCheckoutPage(data.customer)}if(sooAuth.getSourcePage()==="myOrders"){sooAuth.goToMyOrdersPage(data.customer)}}}).fail(function(data){sooAuth.finishSubmitingAform(sooAuth.loginForm);let errorMsg="";if(data.responseJSON&&data.responseJSON.message){errorMsg=data.responseJSON.message}else{errorMsg=mooObjectL10n.useForgetPassword}sooAuth.showErrorAlert(mooObjectL10n.invalidEmailOrPassword,errorMsg)})},goToCheckoutPage:function(customer){if(mooCheckout){mooGlobalParams.isGuest=false;mooCheckout.loggedInCustomer=customer;mooCheckout.showCheckoutDetails()}else{console.log("Checkout JS Not Loaded")}},goToMyOrdersPage:function(customer){if(sooMyOrders){sooMyOrders.showCustomerPanel()}else{console.log("sooMyOrders JS Not Loaded")}}};$(document).ready(function(){window.sooAuth.init()})});